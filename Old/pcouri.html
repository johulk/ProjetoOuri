<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Ouri</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 2400,
    height: 600,
    scene: {
        preload: preload,   
        create: create,
        update: update
    }
};

let game = new Phaser.Game(config);
let state = [];
let player = 1;
let dep1 = 0;
let dep2 = 0;
let check = 0;

function preload (){
    this.load.image('deposito', 'img/deposito.png');
    this.load.image('buraco', 'img/buraco.png');
    for(var i = 0; i<31; i++){
        this.load.image('i'+i, 'img/'+i+'.png')
    }
};

function create() {
    
    //inicializar Tabuleiro Vazio
    this.add.image(150, 300, 'deposito');
    this.add.image(2250, 300, 'deposito');

    for(var j = 0; j<2;j++) {
        for(var i = 0; i<6;i++) {
            this.add.image(450 + i*300, 150 + j*300, 'buraco');
        }
    }
    
    //inicializar Numeros e State inicial
    
    this.add.image(150, 300, 'i0');
    this.add.image(2250, 300, 'i0');
    aux=0;
    for(var j = 0; j<2;j++) {
        for(var i = 0; i<6;i++) {
            this.add.image(450 + i*300, 150 + j*300, 'i4');
            state[aux] = 4;
            aux++;
        }
    }


    // Jogadas
    this.input.on('pointerdown', function (pointer) {
        if (pointer.x>300 && pointer.x<2100 && pointer.y>300 && pointer.y<600 && check == 0){
            
            x = Math.floor((pointer.x/300))-1;
            y = Math.floor((pointer.y/300));

            pos = x 
            valor = state[pos]

            if(valor == 0){
                y = 3
            }

            if(valor == 1){
                y = one(player,state);
            }

            //
            if ((player == 1 && y==1)){
                y = popularOponente(player,state,pos)
            }

            // só deixa jogar o player 1 na fila de baixo
            if ((player == 1 && y==1)){
                
                // retirar as pedras da casa onde clicamos
                state[pos] = 0
                
                // distribuir as pedras pelas casas seguintes
                for(i = 1; valor > 0; i++){
                    //Quando atingir 12 pedras tem de saltar a casa onde clicamos
                    if ((pos + i % 12) != pos){
                        state[(pos + i) % 12] = state[(pos + i) % 12] +1; 
                        valor--;
                    }
                }
                
                
                //verificar se posso recolher alguma pedra
                posfinal = (pos + i - 1) % 12
                state = recolher(player,state,posfinal);
                

                //atualizar as imagens
                aux = 0;
                console.log("update")

                this.add.image(150, 300, 'deposito');
                this.add.image(150, 300, 'i' + dep2);

                this.add.image(2250, 300, 'deposito');
                this.add.image(2250, 300, 'i' + dep1);


                for(var i = 0; i < 6; i++) {
                    this.add.image(450 + i*300, 450, 'buraco');
                    this.add.image(450 + i*300, 450, 'i'+state[aux]);
                    aux++;
                }
                
                for(var i = 5; i >= 0; i--) {
                    this.add.image(450 + i*300, 150, 'buraco');
                    this.add.image(450 + i*300, 150, 'i'+state[aux]);
                    aux++;
                }
                
                if (dep1 > 24){ check = 1 }
                if (dep2 > 24){ check = 1 }


                player = nextPlayer(player,state)
                

                // verifica se há uma possivel jogada para o computador
                y = 0;
                if (player == 1){
                    for(i = 0; i < 6 ; i++){
                        y = y + popularOponente(player,state,i)
                    }
                    if (y == 18){
                        check = 1
                    }
                }

                if (player == 2){
                    for(i = 5; i < 12 ; i++){
                        y = y + popularOponente(player,state,i)
                    }
                    if (y == 18){
                        check = 1
                    }
                }

                if (check == 1){
                        player = terminar(dep1,dep2,state)
                        if (player == 2){
                            console.log("Computer wins")
                        }
                        else{
                            console.log("player "+player+" wins")  
                        }
                    
                }
                
                
                setTimeout(() =>{ 
                    while(player == 2){
                        y = 0
                        // calcula uma casa random para clicar
                        pos = Math.floor(Math.random() * 6 + 6);
                        console.log(pos)

                        //não deixar o jogador jogar quando valor == 1
                        valor = state[pos]
                        

                        if(valor == 0){
                            y = 3
                        }

                        if(valor == 1){
                            y = one(2,state);
                        }


                        // veirficar se tem de dar sementes ao adversário
                        y = popularOponente(2,state,pos)


                        if(y == 0){
                            state[pos] = 0
                             
                             // distribuir as pedras pelas casas seguintes
                            for(i = 1; valor > 0; i++){
                                //Quando atingir 12 pedras tem de saltar a casa onde clicamos
                                if ((pos + i % 12) != pos){
                                    state[(pos + i) % 12] = state[(pos + i) % 12] +1; 
                                    valor--;
                                }
                            }
                            //verificar se posso recolher alguma pedra
                            posfinal = (pos + i - 1) % 12
                            state = recolher(2,state,posfinal);



                             //atualizar as imagens
                            aux = 0;
                            console.log("update")
                            this.add.image(150, 300, 'deposito');
                            this.add.image(150, 300, 'i' + dep2);

                            this.add.image(2250, 300, 'deposito');
                            this.add.image(2250, 300, 'i' + dep1);


                            for(var i = 0; i < 6; i++) {
                                this.add.image(450 + i*300, 450, 'buraco');
                                this.add.image(450 + i*300, 450, 'i'+state[aux]);
                                aux++;
                            }
                            
                            for(var i = 5; i >= 0; i--) {
                                this.add.image(450 + i*300, 150, 'buraco');
                                this.add.image(450 + i*300, 150, 'i'+state[aux]);
                                aux++;
                            }
                            
                            if (dep1 > 24){ check = 1 }
                            if (dep2 > 24){ check = 1 }

                            player = nextPlayer(player,state)

                            y = 0;
                            if (player == 1){
                                for(i = 0; i < 6 ; i++){
                                    y = y + popularOponente(player,state,i)
                                }
                                if (y == 18){
                                    check = 1
                                }
                            }

                            if (player == 2){
                                for(i = 5; i < 12 ; i++){
                                    y = y + popularOponente(player,state,i)
                                }
                                if (y == 18){
                                    check = 1
                                }
                            }

                            if (check == 1){
                                player = terminar(dep1,dep2,state)
                                if(player == 2){
                                    console.log("Computer wins")
                                }
                                else{
                                    console.log("player "+player+" wins")  
                                }
                            }
                        }
                    }
                }, 1000) 
            }    
        }
    }, this);
}


function popularOponente(player,state,pos){
    valor = state[pos]
    if (vazio(player,state) == 1){
        y = 3;
        for(i = 0; i <= valor; i++){
            finalpos = (pos + i) % 12
            if(player == 1){
            // verifico que alguma pedra cai em territorio adversario
                if (finalpos > 5 && finalpos< 12){
                    y = 1;
                }
            }
            else{
                if(finalpos >= 0 && finalpos<6){
                    y = 0;
                }
            } 
        }   
    }
    return y
}


function vazio(player,state){
    soma = 0;

    if (player == 1){
        for(i = 5; i < 12; i++){
            soma = soma + state[i]
        }
    }
    else {
        for(i = 0; i < 6; i++){
            soma = soma + state[i]
        }
    }

    if(soma == 0) {return 1}
    else{
        return 0    
    }
}


function terminar(dep1,dep2,state){
    player = 1
    for(i = 0; i < 6; i++){
        dep1 = dep1 + state[i]
    }
    
    for(i = 5; i < 12; i++){
        dep2 = dep2 + state[i]
    }
    
    if(dep1 > dep2){ player = 1 }
    else { player = 2 }

    return player
}

//funcao que recolhe as pedras para os jogadores
function recolher(player,state,posfinal){
    
    //Recolher as pedras para o player 1
    if (player == 1){
        while((state[posfinal] == 2 || state[posfinal] == 3) && posfinal>5 && posfinal<12){
            dep1 = dep1 + state[posfinal]
            state[posfinal] = 0;
            posfinal = posfinal - 1;

        }       
    }

    //Recolher as pedras para o player 2
    if (player == 2){
        while((state[posfinal] == 2 || state[posfinal] == 3) && posfinal>=0 && posfinal<6){
            dep2 = dep2 + state[posfinal]
            state[posfinal] = 0;
            posfinal = posfinal - 1;
            
        }       
    }
    return state
}

// funcao que procura se existem numeros >1 na fila do jogador
function one(player,state){
    // verifica se na fila de baixo existe algum valor > 1
    if (player == 1){
        for(var i = 0; i<6; i++){
            if (state[i] > 1){
                y = 3
            }
        }
    }
    // verifica se na fila de cima esta algum valor > 1
    if (player == 2){
        for(var i = 6; i<12; i++){
            if (state[i] > 1){
                y = 3
            }
        }
    }
    //retornar y = 3 impede que a jogada prossiga
    return y
}


// Funcao que decide qual é o proximo jogador a jogar
function nextPlayer(player, state){
        totalP1 = 0
        totalP2 = 0

        // Verifica se algum dos tabuleiros estão vazios
        for(i = 0; i < 6; i++){
            totalP1 = totalP1 + state[i]
        }

        for(i = 6; i< 12; i++){
            totalP2 = totalP2 + state[i]
        }

        // Se o player 1 tiver o tabuleiro vazio, joga o player 2
        if (totalP1 == 0){
            player = 2

        }
        // Se o player 2 tiver o tabuleiro vazio, joga o player 1
         else if ( totalP2 == 0){
            player = 1
        } 
        // Se nenhum tiver o tabuleiro vazio alterna-se as jogadas
        else {
            if (player == 1){player = 2} else {player = 1}
        }
    return player
}

function update (){};

</script>

</body>
</html>



